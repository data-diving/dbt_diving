name: Run Tests
run-name: Build a test project and run tests
on:
  pull_request:
    branches: [main]

jobs:
  Run-Tests:
    runs-on: ubuntu-24.04
    steps:
      - name: Greeting Message
        run: echo "Running GitHub action to build and test projectâ€¦"
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install Python & activate virtual environment
        working-directory: test_project
        run: uv venv && source .venv/bin/activate && echo PATH=$PATH >> $GITHUB_ENV
      - name: Install Python & dbt packages        
        working-directory: test_project
        run: uv pip install -r requirements.txt && export DBT_PROFILES_DIR=. && dbt deps
      - name: Set database filename
        run: echo "DB_FILE=/tmp/dbt_diving.duckdb" >> $GITHUB_ENV
      - name: Create source table
        working-directory: test_project
        run: duckdb $DB_FILE "CREATE TABLE source_table (id INTEGER, name VARCHAR);"
      - name: Run & test dbt
        working-directory: test_project
        run: dbt run && dbt test && ./tests.sh
